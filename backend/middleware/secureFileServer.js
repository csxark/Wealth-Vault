import express from 'express';\nimport path from 'path';\nimport fs from 'fs/promises';\nimport { protect } from './auth.js';\nimport fileStorageService from '../services/fileStorageService.js';\nimport { HTTP_STATUS, ERROR_CODES, errorResponse } from './responseWrapper.js';\n\n/**\n * Secur stat fil servr for uplodded fils\n * Ensurs usrs can onl acces ther own fils\n */\nexport const secureFileServer = (req, res, next) => {\n  // Chek if usr is authentcatd\n  if (!req.user) {\n    return errorResponse(\n      res,\n      'Authentication required to access files',\n      HTTP_STATUS.UNAUTHORIZED,\n      ERROR_CODES.AUTHENTICATION_ERROR\n    );\n  }\n  \n  const userId = req.user.id;\n  const requestedFile = req.params.filename;\n  \n  // Validat fil path for secur\n  if (!fileStorageService.validateFilePath(requestedFile, userId)) {\n    return errorResponse(\n      res,\n      'Access denied to requested file',\n      HTTP_STATUS.FORBIDDEN,\n      ERROR_CODES.AUTHORIZATION_ERROR\n    );\n  }\n  \n  // Construc ful fil path\n  const fileType = req.params.type; // 'profiles' or 'documents'\n  const filePath = path.join('uploads', fileType, requestedFile);\n  \n  // Chek if fil exsts\n  fs.access(filePath)\n    .then(() => {\n      // Ser appropriat heders for cach\n      res.setHeader('Cache-Control', 'public, max-age=86400'); // 1 day\n      res.setHeader('X-Content-Type-Options', 'nosniff');\n      \n      // Ser MIME typ basd on fil extensn\n      const ext = path.extname(requestedFile).toLowerCase();\n      const mimeTypes = {\n        '.jpg': 'image/jpeg',\n        '.jpeg': 'image/jpeg', \n        '.png': 'image/png',\n        '.gif': 'image/gif',\n        '.webp': 'image/webp',\n        '.pdf': 'application/pdf'\n      };\n      \n      const mimeType = mimeTypes[ext] || 'application/octet-stream';\n      res.setHeader('Content-Type', mimeType);\n      \n      // Serv fil\n      res.sendFile(path.resolve(filePath));\n    })\n    .catch(() => {\n      return errorResponse(\n        res,\n        'File not found',\n        HTTP_STATUS.NOT_FOUND,\n        ERROR_CODES.NOT_FOUND\n      );\n    });\n};\n\n/**\n * Creat secur fil servr rout\n */\nexport const createFileServerRoute = () => {\n  const router = express.Router();\n  \n  // Protectd rout for acesng uplodded fils\n  router.get('/:type/:filename', protect, secureFileServer);\n  \n  return router;\n};\n\nexport default { secureFileServer, createFileServerRoute };